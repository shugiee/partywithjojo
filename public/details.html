<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Jordyn and Jonathan's Wedding - Event Details</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta charset="UTF-8">
		<meta name="description" content="Details page for Jordyn Levy and Jonathan Olson's wedding in 2025.">
        <link rel="stylesheet" href="./styles.css" />
	</head>
	<body>
        <a href="./details">Event Details</a>
        <a href="./home">Home</a>
        <a href="./accommodations">Accommodations</a>
        <a href="./registry">Registry</a>
        <a href="./faq">FAQs</a>
        <a href="./rsvp">RSVP</a>
        <h1>Event Details</h1>
        <iframe
            width="600"
            height="450"
            style="border:0"
            loading="lazy"
            allowfullscreen
            referrerpolicy="no-referrer-when-downgrade"
            src="https://www.google.com/maps/embed/v1/place?key=AIzaSyCDhUx8u5JVTNSRwPlDqJT3GMxoiUSkhaE&q=Beacon+Grand,San+Francisco+CA">
        </iframe>
        <input type="text" id="spotify-search" />
        <button id="spotify-search-submit">Search</button>
        <div id="spotify-search-results-container">
            <h2>Search results</h2>
            <div id="spotify-search-results" />
        <script>
            const getCookie = (name) => {
                return Object.fromEntries(
                    document.cookie
                    .split('; ')
                    .map(cookie => cookie.split('='))
                )[name] || null;
            };

            const addToPlaylist = async (id) => {
                const playlistId = "4Prc1zbrD2taosqI5usgcy";
                const spotifyToken = getCookie("spotify");
                console.log("Spotify token", spotifyToken);
                const addToPlaylistResponse = await fetch(`https://api.spotify.com/v1/playlists/${id}/tracks?uris=spotify:track:${id}`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${spotifyToken}`,
                        "Content-Type": "application/json",
                    }
                });

                if (!addToPlaylistResponse.ok) {
                    throw new Error(`Response status: ${addToPlaylistResponse.status}`);
                } else {
                    console.log(`Added id ${id} to playlist!`);
                }
            };

            const songSearchResult = ({ id, name, artists }) => `
                <div class="search-result-container">
                    <button onclick="addToPlaylist('${id}')">
                        <div class="song-name">${name}</div>
                        <div class="artists">${artists.join(" ")}</div>
                    </button>
                </div>
            `;

            const searchResults = (songs) => `<div id="search-results">${songs.map(song => songSearchResult(song)).join("")}</div>`;
            
            const searchSpotify = async () => {
                const spotifyToken = getCookie("spotify");
                const text = document.getElementById("spotify-search").value;
                const params = new URLSearchParams();
                params.append("q", text);
                params.append("type", "track");
                const spotifyResponse = await fetch(`https://api.spotify.com/v1/search?${params}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${spotifyToken}`
                    },
                });

                if (!spotifyResponse.ok) {
                    throw new Error(`Response status: ${spotifyResponse.status}`);
                }

                const json = await spotifyResponse.json();
                const searchResultsElement = document.getElementById("spotify-search-results");
                const songs = json.tracks.items.map(track => {
                    const { name, artists, id } = track;
                    return {name, artists: artists.map(artist => artist.name), id};
                });
                searchResultsElement.innerHTML = searchResults(songs);
            };
            document.getElementById("spotify-search-submit").addEventListener("click", searchSpotify);
        </script>
    </body>
</html>
